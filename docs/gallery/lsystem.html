<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>L-System Tree</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;background:#0a0a0f;overflow:hidden}
canvas{display:block;width:100%;height:100%}
#info{position:fixed;bottom:16px;left:16px;color:rgba(255,255,255,0.5);font:13px/1.4 ui-monospace,monospace;pointer-events:none;max-width:90vw}
#ctrl{position:fixed;top:16px;left:16px;color:rgba(255,255,255,0.3);font:13px ui-monospace,monospace;pointer-events:none}
#buttons{position:fixed;bottom:16px;right:16px;display:flex;gap:8px}
#buttons button{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.6);font:14px ui-monospace,monospace;padding:8px 14px;border-radius:8px;cursor:pointer}
#buttons button:hover{background:rgba(255,255,255,0.14);color:rgba(255,255,255,0.9)}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="ctrl">depth 4 · angle 25°</div>
<div id="info">L-System tree (Lindenmayer, 1968) · click/tap to regrow</div>
<div id="buttons">
<button onclick="changeDepth(-1)">depth −</button>
<button onclick="changeDepth(1)">depth +</button>
<button onclick="changeAngle(-5)">angle −</button>
<button onclick="changeAngle(5)">angle +</button>
</div>
<script>
const c=document.getElementById('c'),ctx=c.getContext('2d');
let W,H,depth=4,angle=25,seed=Date.now(),growing=true,progress=0;
let cachedStr='',cachedDepth=-1;

function produce(axiom,iterations){
  let s=axiom;
  for(let i=0;i<iterations;i++){
    let n='';
    for(const ch of s){
      if(ch==='F')n+='FF+[+F-F-F]-[-F+F+F]';
      else n+=ch;
    }
    s=n;
  }
  return s;
}

function getStr(){
  if(cachedDepth!==depth){cachedStr=produce('F',depth);cachedDepth=depth}
  return cachedStr;
}

function pseudoRandom(s){let h=s|0;return()=>{h=Math.imul(h^(h>>>16),2246822507);h=Math.imul(h^(h>>>13),3266489909);return((h^=h>>>16)>>>0)/4294967296}}

function countF(str){let n=0;for(const ch of str)if(ch==='F')n++;return n}

function render(pct){
  ctx.fillStyle='#0a0a0f';ctx.fillRect(0,0,W,H);
  const str=getStr();
  const total=countF(str);
  const drawCount=Math.floor(total*pct);
  const len=Math.min(W,H)/(Math.pow(2,depth)*1.2);
  const rad=angle*Math.PI/180;
  const rng=pseudoRandom(seed);

  ctx.save();
  ctx.translate(W/2,H*0.92);
  ctx.rotate(-Math.PI/2);

  let fCount=0;
  for(const ch of str){
    if(ch==='F'){
      if(fCount>=drawCount)break;
      const depthRatio=ctx.getTransform?0.5:0.5;
      const hue=100+(fCount/total)*60;
      const lum=30+(fCount/total)*25;
      const w=Math.max(0.5,(1-fCount/total)*3.5);
      ctx.strokeStyle=`hsl(${hue},50%,${lum}%)`;
      ctx.lineWidth=w;
      ctx.beginPath();ctx.moveTo(0,0);
      const l=len*(0.8+rng()*0.4);
      ctx.lineTo(l,0);ctx.stroke();
      ctx.translate(l,0);
      fCount++;
    }else if(ch==='+'){
      ctx.rotate(rad*(0.8+rng()*0.4));
    }else if(ch==='-'){
      ctx.rotate(-rad*(0.8+rng()*0.4));
    }else if(ch==='['){
      ctx.save();
    }else if(ch===']'){
      ctx.restore();
    }
  }
  ctx.restore();
  document.getElementById('ctrl').textContent=`depth ${depth} · angle ${angle}°`;
}

function regrow(){seed=Date.now();cachedDepth=-1;progress=0;growing=true}
function changeDepth(d){depth=Math.max(1,Math.min(6,depth+d));regrow()}
function changeAngle(d){angle=Math.max(5,Math.min(45,angle+d));regrow()}

function resize(){W=c.width=innerWidth;H=c.height=innerHeight;regrow()}
resize();addEventListener('resize',resize);

function loop(){
  if(growing){progress=Math.min(1,progress+0.012);if(progress>=1)growing=false}
  render(progress);
  requestAnimationFrame(loop);
}
loop();

addEventListener('click',e=>{if(e.target.tagName==='BUTTON')return;regrow()});
addEventListener('keydown',e=>{
  if(e.key==='ArrowUp')changeDepth(1);
  if(e.key==='ArrowDown')changeDepth(-1);
  if(e.key==='ArrowRight')changeAngle(5);
  if(e.key==='ArrowLeft')changeAngle(-5);
});
</script>
</body>
</html>
